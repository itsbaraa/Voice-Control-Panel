<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Servo Controller</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon"><i class="bi bi-robot"></i></div>
                <h1>Voice Servo Controller</h1>
            </div>
            <div class="status-indicator">
                <div class="status-dot" id="status-dot"></div>
                <span id="status-text">Ready to listen</span>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="chat-main">
            <div class="chat-container">
                <!-- Direction Display -->
                <div class="direction-display-container">
                    <div class="direction-card" id="direction-card">
                        <div class="direction-icon">
                            <i class="bi bi-arrow-up-circle" id="direction-icon"></i>
                        </div>
                        <h2 id="direction-text">No Direction Set</h2>
                    </div>
                </div>
                
                <!-- Speech Transcript Display -->
                <div class="transcript-display" id="transcript-display">
                    <div class="transcript-content">
                        <div class="transcript-icon">
                            <i class="bi bi-chat-dots"></i>
                        </div>
                        <p id="transcript-text">Click microphone and speak...</p>
                    </div>
                </div>
                
                <!-- Real-time Speech Display -->
                <div class="realtime-speech" id="realtime-speech">
                    <div class="speech-indicator">
                        <div class="wave-animation">
                            <span></span><span></span><span></span><span></span><span></span>
                        </div>
                        <p id="realtime-text">Listening...</p>
                    </div>
                </div>
            </div>
        </main> 
       <!-- Controls -->
        <div class="controls-container">
            <div class="input-methods">
                <div class="mic-container">
                    <button class="mic-button" id="mic-button">
                        <div class="mic-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="22"></line>
                            </svg>
                        </div>
                        <div class="pulse-ring"></div>
                        <div class="pulse-ring-2"></div>
                    </button>
                    <p class="mic-label">Click to speak</p>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <p>جاري المعالجة...</p>
        </div>
    </div>

    <script>
        class VoiceServoController {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.isInitialized = false;
                this.initElements();
                this.checkBrowserSupport();
                this.bindEvents();
            }
            
            initElements() {
                this.micButton = document.getElementById('mic-button');
                this.statusDot = document.getElementById('status-dot');
                this.statusText = document.getElementById('status-text');
                this.directionCard = document.getElementById('direction-card');
                this.directionIcon = document.getElementById('direction-icon');
                this.directionText = document.getElementById('direction-text');
                this.directionSubtitle = document.getElementById('direction-subtitle');
                this.transcriptDisplay = document.getElementById('transcript-display');
                this.transcriptText = document.getElementById('transcript-text');
                this.realtimeSpeech = document.getElementById('realtime-speech');
                this.realtimeText = document.getElementById('realtime-text');
                this.loadingOverlay = document.getElementById('loading-overlay');
            }
            
            checkBrowserSupport() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    this.updateStatus('Speech recognition not supported in this browser. Please use Chrome, Edge, or Safari.', 'error');
                    this.micButton.disabled = true;
                    return false;
                }
                
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    this.updateStatus('Speech recognition requires HTTPS or localhost', 'error');
                    this.micButton.disabled = true;
                    return false;
                }
                
                this.updateStatus('Ready to listen', 'ready');
                return true;
            }
            
            initSpeechRecognition() {
                if (this.isInitialized) return;
                
                console.log('Initializing speech recognition...');
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-US';
                this.recognition.maxAlternatives = 1;
                
                this.recognition.onstart = () => {
                    console.log('Speech recognition started');
                    this.isListening = true;
                    this.updateStatus('Listening...', 'listening');
                    this.micButton.classList.add('recording');
                    this.showRealtimeSpeech();
                };
                
                this.recognition.onresult = (event) => {
                    console.log('Speech recognition result:', event);
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    const displayText = finalTranscript || interimTranscript;
                    this.updateTranscript(displayText);
                    this.realtimeText.textContent = displayText || 'Listening...';
                    
                    if (finalTranscript) {
                        console.log('Final transcript:', finalTranscript);
                        this.processCommand(finalTranscript.toLowerCase().trim());
                    }
                };
                
                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    let errorMessage = '';
                    
                    switch(event.error) {
                        case 'not-allowed':
                            errorMessage = 'Microphone access denied';
                            break;
                        case 'no-speech':
                            errorMessage = 'No speech detected';
                            break;
                        case 'audio-capture':
                            errorMessage = 'No microphone found';
                            break;
                        case 'network':
                            errorMessage = 'Network error';
                            break;
                        default:
                            errorMessage = 'Recognition error: ' + event.error;
                    }
                    
                    this.updateStatus(errorMessage, 'error');
                    this.stopListening();
                };
                
                this.recognition.onend = () => {
                    console.log('Speech recognition ended');
                    if (this.isListening) {
                        this.stopListening();
                    }
                };
                
                this.isInitialized = true;
                console.log('Speech recognition initialized successfully');
            }
            
            bindEvents() {
                this.micButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    console.log('Microphone button clicked, isListening:', this.isListening);
                    
                    if (this.isListening) {
                        this.stopListening();
                    } else {
                        this.startListening();
                    }
                });
                
                document.addEventListener('click', () => {
                    if (!this.isInitialized) {
                        this.initSpeechRecognition();
                    }
                }, { once: true });
            }
            
            async startListening() {
                console.log('Attempting to start listening...');
                
                if (!this.isInitialized) {
                    this.initSpeechRecognition();
                }
                
                if (!this.recognition) {
                    this.updateStatus('Speech recognition not available', 'error');
                    return;
                }
                
                if (this.isListening) {
                    console.log('Already listening, ignoring start request');
                    return;
                }
                
                try {
                    this.transcriptText.textContent = 'Listening...';
                    this.updateStatus('Starting microphone...', 'processing');
                    this.recognition.start();
                    console.log('Speech recognition start() called');
                    
                } catch (error) {
                    console.error('Error starting speech recognition:', error);
                    this.updateStatus('Could not start microphone', 'error');
                    this.stopListening();
                }
            }
            
            stopListening() {
                console.log('Stopping listening...');
                
                if (this.recognition && this.isListening) {
                    try {
                        this.recognition.stop();
                    } catch (error) {
                        console.error('Error stopping recognition:', error);
                    }
                }
                
                this.isListening = false;
                this.micButton.classList.remove('recording');
                this.hideRealtimeSpeech();
                this.updateStatus('Ready to listen', 'ready');
            }
            
            showRealtimeSpeech() {
                this.realtimeSpeech.classList.add('active');
            }
            
            hideRealtimeSpeech() {
                this.realtimeSpeech.classList.remove('active');
            }
            
            updateStatus(message, type) {
                this.statusText.textContent = message;
                
                // Update status dot color based on type
                this.statusDot.style.background = type === 'error' ? '#ff4757' : 
                                                 type === 'listening' ? '#ffa500' :
                                                 type === 'processing' ? '#00d4ff' : '#00ff88';
                
                console.log('Status updated:', message, type);
            }
            
            updateTranscript(text) {
                this.transcriptText.textContent = text;
            }
            
            async processCommand(command) {
                this.updateStatus('Processing command...', 'processing');
                this.showLoading();
                console.log('Processing command:', command);
                
                let direction = null;
                if (command.includes('forward')) {
                    direction = 'forward';
                } else if (command.includes('backward')) {
                    direction = 'backward';
                }
                
                if (direction) {
                    try {
                        const response = await fetch('save_direction.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `direction=${direction}`
                        });
                        
                        const result = await response.json();
                        console.log('Server response:', result);
                        
                        if (result.success) {
                            this.updateDirectionDisplay(direction);
                            this.updateStatus(`Command "${direction}" saved!`, 'ready');
                        } else {
                            this.updateStatus('Failed to save command', 'error');
                        }
                    } catch (error) {
                        this.updateStatus('Network error', 'error');
                        console.error('Network error:', error);
                    }
                } else {
                    this.updateStatus('Say "Forward" or "Backward"', 'ready');
                }
                
                this.hideLoading();
            }
            
            updateDirectionDisplay(direction) {
                this.directionText.textContent = `Direction: ${direction.toUpperCase()}`;
                this.directionSubtitle.textContent = `Servo moving ${direction}`;
                
                // Update icon and styling based on direction
                if (direction === 'forward') {
                    this.directionIcon.className = 'bi bi-arrow-up-circle';
                    this.directionCard.style.background = 'linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 212, 255, 0.2))';
                } else {
                    this.directionIcon.className = 'bi bi-arrow-down-circle';
                    this.directionCard.style.background = 'linear-gradient(135deg, rgba(255, 71, 87, 0.2), rgba(255, 165, 0, 0.2))';
                }
            }
            
            showLoading() {
                this.loadingOverlay.classList.add('active');
            }
            
            hideLoading() {
                this.loadingOverlay.classList.remove('active');
            }
        }
        
        // Initialize the controller when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing VoiceServoController');
            new VoiceServoController();
        });
    </script>
</body>
</html>